= Phase 5: Connect your client applications directly to the target
:navtitle: Phase 5: Connect client applications directly to the target
:page-tag: migration,zdm,zero-downtime,zdm-proxy,connect-apps,target

Phase 5 is the last phase of the xref:ROOT:introduction.adoc[migration process].
In this phase, you configure your client applications to connect directly and exclusively to the target cluster.
This removes the dependency on {product-proxy} and completes the migration.

image::migration-phase5ra.png[In Phase 5, your applications no longer using the proxy and, instead, connect directly to the target.]

The minimum requirements for reconfiguring these connections depend on whether your target cluster is {astra-db} or a generic CQL cluster, such as {cass-reg}, {dse}, or {hcd}.

[WARNING]
====
Once you switch your client applications to connect directly to the target cluster, you can no longer cleanly roll back to the origin cluster.
From this point onward, the clusters will diverge, and the target cluster becomes the source of truth for your client applications and data.

Be sure that you have thoroughly xref:ROOT:migrate-and-validate-data.adoc[validated your data (Phase 2)], xref:ROOT:enable-async-dual-reads.adoc[tested your target cluster's performance (Phase 3)], and xref:ROOT:change-read-routing.adoc[routed all reads to the target (Phase 4)] before permanently switching the connection.
====

== Connect a driver to a generic CQL cluster

If your origin and target clusters are both generic CQL clusters ({cass-short}, {dse-short}, or {hcd-short}), then the driver connection strings can be similar, requiring only minor changes to connect to the target cluster.

. At minimum, update your driver configuration to use the appropriate contact points for your target cluster.
+
You might need to make additional configuration changes depending on your target cluster's setup, such as authentication and encryption.
For example, if you have execution profiles with unique datacenter-aware load balancing policies, you must update the profiles to use the target datacenters.
+
For information about driver connections for different {cass-short}-compatible clusters, see xref:datastax-drivers:connecting:connect-cloud.adoc[].

. Verify that your driver version is compatible with your target cluster and supports the features that you want to use on your new cluster.
For example, if you want to use the vector data type on an {hcd-short} cluster, you must use a driver version that supports both {hcd-short} and the vector type.
+
When upgrading from an older driver version, you might need to make additional code changes to account for enhancements, deprecations, removals, and differences in platform features.
Depending on your application's requirements, you might need to make these changes immediately, or you might make them after switching the connection.
+
For more information on supported drivers, see xref:datastax-drivers:compatibility:driver-matrix.adoc[].

== Connect a driver to {astra-db}

Connections to {astra-db} are different from connections to generic CQL clusters.

=== Get {astra-db} credentials

To connect a driver to {astra-db}, you need the following:

* An xref:astra-db-serverless:administration:manage-application-tokens.adoc[application token] with sufficient permissions to execute the required operations, such as the **Database Administrator** role.
+
You must specify one of the following sets of credentials in your driver configuration:
+
** Token-only authentication (Recommended):
+
*** Set `username` to the literal string `token`.
*** Set `password` to the actual application token value (`AstraCS:...`).
+
** Legacy authentication for older applications and drivers:
+
*** Set `username` to the `clientId` value generated with the token.
*** Set `password` to the `secret` value generated with the token.

* Your {astra-db} database's xref:astra-db-serverless:databases:secure-connect-bundle.adoc[{scb}].
+
[IMPORTANT]
====
The {scb-short} contains sensitive information that establishes a connection to your database, including key pairs and certificates.
Treat it as you would any other sensitive values, such as passwords or tokens.
====
+
For multi-region databases and {astra} organizations that use custom domains, your databases will have more than one {scb-short}.
After making these changes in {astra}, your driver connections will need to be updated to use the appropriate {scb-short} for the desired region or domain when connecting to your databases.

[#compare-connection-parameters]
=== Compare driver connection parameters for self-managed {cass-short} clusters and {astra-db}

To help you understand the required changes for your driver connection strings, the following table compares driver connection parameters for self-managed {cass-short} clusters and {astra-db} databases:

[cols=3]
|===
| Parameter | Self-managed clusters | {astra-db} databases

| Contact points
| Required, set manually
| Automatically set by the {scb-short}

| {scb}
| Not applicable
| Required

| SSL context
| Optional, set manually
| Automatically set by the {scb-short}

| Local datacenter
| Required, set manually
| Automatically set by the {scb-short}

| Database username
| Requirement depends on cluster configuration.
If required, set to the relevant user name for authentication.
a| Required.

* Token-only authentication (Recommended): Set to the literal string `token`.
* Client ID and secret authentication (Legacy): Set to the `clientId` generated with your token.

| Database password
| Requirement depends on cluster configuration.
If required, set to the relevant password for authentication.
a| Required.

* Token-only authentication (Recommended): Set to your application token (`AstraCS:...`).
* Client ID and secret authentication (Legacy): Set to the `secret` generated with your token.
|===

=== Verify driver compatibility and update connection strings

Verify that your driver version is compatible with {astra-db} and the features that you want to use in {astra-db}, such as the vector data type.
For more information, see xref:datastax-drivers:compatibility:driver-matrix.adoc[].

If your client application uses an older driver version without built-in {scb-short} support, {company} strongly recommends upgrading to a compatible driver to simplify configuration and get the latest features and bug fixes.
If you prefer to make this change after the migration, or you must support a legacy application that relies on an older driver, you can connect to {astra-db} with https://github.com/datastax/cql-proxy[CQL Proxy], or by extracting the {scb-short} archive and using the individual files to enable mTLS in your driver's configuration.

If your driver has built-in support for the {astra-db} {scb-short}, the changes to enable your application to connect to {astra-db} are minimal.
The following example demonstrates an {astra-db} connection through the Python driver using an {scb-short} and application token.
For more information and examples, see <<compare-connection-parameters>> and xref:datastax-drivers:connecting:connect-cloud.adoc[].

[source,python]
----
import os
from cassandra.cluster import Cluster
from cassandra.auth import PlainTextAuthProvider
import json

cloud_config= {
        'secure_connect_bundle': '/path/to/scb.zip'
        }
auth_provider = PlainTextAuthProvider("token", os.environ["APPLICATION_TOKEN"])
cluster = Cluster(cloud=cloud_config, auth_provider=auth_provider)
session = cluster.connect()
----

.Driver pseudocode to connect to {astra-db}
[%collapsible]
====
//Recalling the xref:connect-clients-to-proxy.adoc#_connecting_company_drivers_to_cassandra[pseudocode to enable your client application to connect to the proxy], here it is how your code needs to change to connect directly to {astra-db}:

The following pseudocode provides guidance on how you might change your driver's code to connect directly to {astra-db}.
This is for illustration purposes only; the exact syntax depends on your driver and programming language.

[source,text]
----
// Create an object to represent a Cassandra cluster
// Note: there is no need to specify contact points when connecting to Astra DB.
// All connection information is implicitly passed in the SCB
Cluster my_cluster = Cluster.build_new_cluster(username="my_AstraDB_client_ID", password="my_AstraDB_client_secret", secure_connect_bundle="/path/to/scb.zip")

// Connect our Cluster object to our Cassandra cluster, returning a Session
Session my_session = my_cluster.connect()

// Execute a query, returning a ResultSet
ResultSet my_result_set = my_session.execute("select release_version from system.local")

// Retrieve the "release_version" column from the first row of our result set
String release_version = my_result_set.first_row().get_column("release_version")

// Close our Session and Cluster
my_session.close()
my_cluster.close()

// Display the release version to the user
print(release_version)
----
====

=== Other code changes for {astra-db}

In addition to updating connection strings, you might also need to make the following code changes:

* Feature compatibility between your old and new database platform.
For example, after migrating to {astra-db}, your drivers cannot create keyspaces because xref:astra-db-serverless:cql:develop-with-cql.adoc[CQL for {astra-db}] doesn't support `CREATE KEYSPACE`.

* Enhancements, deprecations, and removals when upgrading from an older driver version.

Depending on your application's requirements, you might need to make these changes immediately, or you might make them after switching the connection.

== Switch to the Data API

If you migrated to {astra-db} or {hcd-short}, and you have the option of using the Data API instead of, or in addition to, a {cass-short} driver.

Although the Data API can read and write to CQL tables, it is significantly different from driver code.
To use the Data API, you must rewrite your application code or create a new application.

For more information, see the following:

* xref:astra-db-serverless:api-reference:dataapiclient.adoc[Get started with the Data API in {astra-db}]
* xref:astra-db-serverless:api-reference:compare-dataapi-to-cql.adoc[Migrate to the Data API from CQL in {astra-db}]
* xref:hyper-converged-database:api-reference:dataapiclient.adoc[Get started with the Data API in {hcd-short}]
* xref:hyper-converged-database:api-reference:compare-dataapi-to-cql.adoc[Migrate to the Data API from CQL in {hcd-short}]

== Migration complete

Your migration is now complete, and your target cluster is the source of truth for your client applications and data.

When you are ready, you can decommission your origin cluster and {product-proxy}, as these are no longer needed and clean xref:ROOT:rollback.adoc[rollback] is no longer possible.

If you need to revert to the origin cluster after this point, you must perform a full migration with your old origin cluster as the target to ensure that all data is rewritten and synchronized back to the origin.

== See also

* https://www.datastax.com/events/migrating-your-legacy-cassandra-app-to-astra-db[Migrating your legacy {cass-reg} app to {astra-db}]