= Run Ansible playbooks with {zdm-automation} to deploy the proxy and monitoring

This topic explains how to use the {zdm-automation} to run the Ansible automation playbooks that you setup in the xref:migration-setup-ansible-playbooks.adoc[prior topic]. 

Once completed, you will have a working and fully monitored {zdm-proxy} deployment.

== Prerequisites

. You must have already provisioned the ZDM infrastructure; which means you must have the server machines ready, and know their IP addresses. These can be in the cloud provider of your choice or on-premise.
. Docker needs to be installed on the machine that will be used as the Ansible Control Host, and the `docker` command must not require superuser privileges. The instructions to do this are available for each platform in the official Docker documentation. (Alice's note: add links)
. You must have completed the Ansible setup as described in the xref:migration-setup-ansible-playbooks.adoc[prior topic].

== Connect to the Docker container

Now you can connect to the Docker container. Example:

```bash
docker exec -it zdm-ansible-container bash
```

You're connected to the container, at a prompt such as this example:

```bash
ubuntu@52772568517c:~$
```

You can `ls` to see the resources in the Docker container. The most important resource is the `zdm-proxy-automation`.

Now, `cd` into `zdm-proxy-automation` and `ls` to see its content. From there, cd to the ansible subdirectory and `ls`. Example:

image:zdm-ansible-container-ls.png[]

== Edit zdm_proxy_core_config.yml

The next step is to edit the `zdm_proxy_core_config.yml` file in the Docker container. You'll want to enter your Cassandra/DSE username, password, and other values.

. cd to ~/zdm-proxy-automation/ansible/vars
. Edit `zdm_proxy_core_config.yml`
. Uncomment and enter values for the following Origin settings of your Cassandra or DSE database:
.. `origin_cassandra_username`
.. `origin_cassandra_password`
.. `origin_cassandra_contact_points`
.. `origin_cassandra_port`
.. (TODO: brief explanation of `origin_cassandra_contact_points` here - where to get the IPs.)
.. Remove all other Origin-related parameters, or ignore them (leaving them commented out)
. Uncomment and enter values for the following Target settings of your new Astra database:
.. `target_cassandra_username`: Client ID of your Astra Read / Write User role
.. `target_cassandra_password`: Client Secret of your Astra Read / Write User role
.. `target_astra_db_id`: database ID of your Astra cluster (can be found in the Dashboard of the Astra UI)
.. `target_astra_token`: Token of your Astra Read / Write User role
.. Remove all other Target-related parameters, or ignore them (leaving them commented out)
. Leave `forward_reads_to_target` set to its default value of `false`
. Save the file and exit the editor

+
Example of a completed zdm_proxy_core_config.yml file [ TODO update variable names and populate target db id and token ] :
+
```yml
---
### Origin configuration

# Origin credentials (always required)
origin_cassandra_username: my_user
origin_cassandra_password: my_password

# Set the following two parameters only if Origin is a self-managed, non-Astra cluster
origin_cassandra_contact_points: 191.100.20.85,191.100.20.61,191.100.20.93
origin_cassandra_port: 9042

### Target configuration

# Target credentials (always required)
target_cassandra_username: dqhgDYKvtEGNDDFyrgzrNndY
target_cassandra_password: Yc+U_2.gu,9woy0wSdBge6l1txjYtLwyD_mdQ.ASf8y+NNgRAy004Z_1DRNFEjgchDayKwXZSxeKu_n-ZcAiBGOXt99o8HD8uTPe5rER4bvYP1EAtpkk9JpAZGt+CCn5

# Set the following two parameters only if Target is an Astra cluster and you would like the automation to download the secure connect bundle automatically
target_astra_db_id: <cluster id of the Target Astra cluster>
target_astra_token: <token of the same role as above >

# Set the following two parameters only if Target is a self-managed, non-Astra cluster
#target_cassandra_contact_points: <comma-separated list of private IP addresses, no spaces>
#target_cassandra_port: <typically 9042>

# Destination for all read requests. Set to false to send all reads to Origin, or true to send all reads to Target
forward_reads_to_target: false
```

== Use Ansible to run the playbook

Now you can run the playbook that you've configured above.

```bash
ansible-playbook deploy_zdm_proxy.yml -i zdm_ansible_inventory
```

== Indications of success on Origin and Target clusters

The playbook will create one ZDM proxy instance for each proxy host listed in the inventory file. It will indicate the operations that it is performing and print out any errors, or a success confirmation message at the end.

How can you confirm that the ZDM proxies are up and running?

After running the playbook, you can `ssh` into one of the servers where one of the deployed {zdm-proxy} instances is running. You can do so from within the Ansible container, or directly from the jumphost machine:

```bash
ssh ubuntu@<zdm proxy ip address>
```

Then, use the `docker logs` command to view the logs of this ZDM proxy instance:

```bash
   .
   .
   .
ubuntu@ip-172-18-10-111:~$ sudo docker logs zdm-proxy-container
   .
   .
   .
time="2022-10-01T22:21:42Z" level=info msg="Initialized origin control connection. Cluster Name: OriginCluster, Hosts: map[3025c4ad-7d6a-4398-b56e-87d33509581d:Host{addr: 191.100.20.61,
port: 9042, host_id: 3025c4ad7d6a4398b56e87d33509581d} 7a6293f7-5cc6-4b37-9952-88a4b15d59f8:Host{addr: 191.100.20.85, port: 9042, host_id: 7a6293f75cc64b37995288a4b15d59f8} 997856cd-0406-45d1-8127-4598508487ed:Host{addr: 191.100.20.93, port: 9042, host_id: 997856cd040645d181274598508487ed}], Assigned Hosts: [Host{addr: 191.100.20.61, port: 9042, host_id: 3025c4ad7d6a4398b56e87d33509581d}]."

time="2022-10-01T22:21:42Z" level=info msg="Initialized target control connection. Cluster Name: cndb, Hosts: map[69732713-3945-4cfe-a5ee-0a84c7377eaa:Host{addr: 10.0.79.213,
port: 9042, host_id: 6973271339454cfea5ee0a84c7377eaa} 6ec35bc3-4ff4-4740-a16c-03496b74f822:Host{addr: 10.0.86.211, port: 9042, host_id: 6ec35bc34ff44740a16c03496b74f822} 93ded666-501a-4f2c-b77c-179c02a89b5e:Host{addr: 10.0.52.85, port: 9042, host_id: 93ded666501a4f2cb77c179c02a89b5e}], Assigned Hosts: [Host{addr: 10.0.52.85, port: 9042, host_id: 93ded666501a4f2cb77c179c02a89b5e}]."
time="2022-07-27T22:21:42Z" level=info msg="Proxy connected and ready to accept queries on 172.18.10.111:9042"
time="2022-07-27T22:21:42Z" level=info msg="Proxy started. Waiting for SIGINT/SIGTERM to shutdown."
```

[ TODO change screenshots with updated names ]

In the logs, the important information to notice is:

```bash
time="2022-07-27T22:21:42Z" level=info msg="Proxy connected and ready to accept queries on 172.18.10.111:9042"
time="2022-07-27T22:21:42Z" level=info msg="Proxy started. Waiting for SIGINT/SIGTERM to shutdown."
```
[ TODO change screenshots with updated names]

Also, you can check the status of the running Docker image. Example:

```bash
ubuntu@ip-172-18-10-111:~$ sudo docker ps
CONTAINER ID  IMAGE                         COMMAND  CREATED      STATUS     PORTS   NAMES
02470bbc1338  datastax/zdm-proxy:1.x  "/main"  2 hours ago  Up 2 hours         zdm-proxy-container
```
== Setting up Monitoring on the control host

Follow these steps to install the monitoring stack.  We'll use https://grafana.com/[Grafana] to visualize the data.

Make sure you are connected to the Ansible Control Host docker container. As above, you can do so from the jumphost machine by running:
```bash
docker exec -it zdm-ansible-container bash
```
You will see a prompt like:
```bash
ubuntu@52772568517c:~$
```

=== Configure the Grafana credentials

Edit the file `zdm_monitoring_config.yml`, located in `zdm-proxy-automation/ansible/vars`:
. `grafana_admin_user`: leave unchanged (defaults to `admin`)
. `grafana_admin_password`: set to the password of your choice

=== Run the monitoring playbook

Use the following command:

```bash
ansible-playbook deploy_zdm_monitoring.yml -i zdm_ansible_inventory
```

=== Check the Grafana dashboard

In a browser, open http://<jumphost_public_ip>:3000.

Login with:

**username**: admin

**password**: the password you configured

(TODO: show Grafana screenshot and details about what to observe.)

== What's next?

Learn how to xref:migration-connect-clients-to-proxy.adoc[].

